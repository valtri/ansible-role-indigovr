#
# OpenVPN - centralpoint VPN config
#

# --- OpenVPN specs
mode server
persist-key
persist-tun
tls-server
user {{ INDIGOVR_USER }}
group {{ INDIGOVR_USER }}
dev tun
topology p2p
proto udp
port 1194
comp-lzo

# --- IP addresses for VPN
server {{ INDIGOVR_VPN_SUBNET | ipaddr('network') }} {{ INDIGOVR_VPN_SUBNET | ipaddr('netmask') }}
ifconfig-pool-persist ipp.txt

# --- Client specs
max-clients 250
keepalive 5 10
client-to-client
client-config-dir /etc/openvpn/ccd

# --- Certificates
ca {{ INDIGOVR_CERT_DIR }}/ca.crt
cert {{ INDIGOVR_CERT_DIR }}/{{ INDIGOVR_CERT_NAME }}.crt
key {{ INDIGOVR_CERT_DIR }}/{{ INDIGOVR_CERT_NAME }}.key
dh {{ INDIGOVR_CERT_DIR }}/dh2048.pem
crl-verify {{ INDIGOVR_CERT_DIR }}/crl.pem

# --- LOG files
log-append /var/log/openvpn
{% if ansible_distribution == 'CentOS' %}
status /var/run/openvpn-server/vpn.status 10
{% else %}
status /var/run/openvpn/vpn.status 10
{% endif %}

# --- IPv4 routing
route {{ INDIGOVR_SUBNET | ipaddr('network') }} {{ INDIGOVR_SUBNET | ipaddr('netmask') }} {{ INDIGOVR_VPN_SUBNET | ipaddr('2') | ipaddr('address') }}

push "route-gateway {{ INDIGOVR_VPN_SUBNET | ipaddr('1') | ipaddr('address') }}"
push "route {{ INDIGOVR_SUBNET | ipaddr('network') }} {{ INDIGOVR_SUBNET | ipaddr('netmask') }} vpn_gateway"
